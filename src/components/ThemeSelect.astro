---
/**
 * Custom theme toggle - Mintlify style icon button
 * Replaces default Starlight dropdown with a simple toggle button
 */
---

<starlight-theme-select>
  <button class="theme-toggle group" aria-label={Astro.locals.t('themeSelect.accessibleLabel')}>
    <!-- Sun icon - visible in light mode -->
    <svg
      class="icon icon-sun"
      width="16"
      height="16"
      viewBox="0 0 16 16"
      fill="none"
      stroke="currentColor"
      xmlns="http://www.w3.org/2000/svg"
    >
      <g clip-path="url(#sun-clip)">
        <path
          d="M8 1.11133V2.00022"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
        <path
          d="M12.8711 3.12891L12.2427 3.75735"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
        <path d="M14.8889 8H14" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
        ></path>
        <path
          d="M12.8711 12.8711L12.2427 12.2427"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
        <path d="M8 14.8889V14" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
        ></path>
        <path
          d="M3.12891 12.8711L3.75735 12.2427"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
        <path
          d="M1.11133 8H2.00022"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
        <path
          d="M3.12891 3.12891L3.75735 3.75735"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
        <path
          d="M8.00043 11.7782C10.0868 11.7782 11.7782 10.0868 11.7782 8.00043C11.7782 5.91402 10.0868 4.22266 8.00043 4.22266C5.91402 4.22266 4.22266 5.91402 4.22266 8.00043C4.22266 10.0868 5.91402 11.7782 8.00043 11.7782Z"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </g>
      <defs>
        <clipPath id="sun-clip">
          <rect width="16" height="16" fill="white"></rect>
        </clipPath>
      </defs>
    </svg>
    <!-- Moon icon - visible in dark mode -->
    <svg
      class="icon icon-moon"
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
    </svg>
  </button>
</starlight-theme-select>

{/* Inlined to avoid FOUC. Uses global scope from ThemeProvider.astro */}
<script is:inline>
  /* global StarlightThemeProvider */
  StarlightThemeProvider.updatePickers();
</script>

<script>
  type Theme = 'auto' | 'dark' | 'light';

  const storageKey = 'starlight-theme';

  const parseTheme = (theme: unknown): Theme =>
    theme === 'auto' || theme === 'dark' || theme === 'light' ? theme : 'auto';

  const loadTheme = (): Theme =>
    parseTheme(typeof localStorage !== 'undefined' && localStorage.getItem(storageKey));

  function storeTheme(theme: Theme): void {
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem(storageKey, theme === 'light' || theme === 'dark' ? theme : '');
    }
  }

  const getPreferredColorScheme = (): Theme =>
    matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';

  function onThemeChange(theme: Theme): void {
    // eslint-disable-next-line no-undef
    StarlightThemeProvider.updatePickers(theme);
    document.documentElement.dataset.theme = theme === 'auto' ? getPreferredColorScheme() : theme;
    storeTheme(theme);
  }

  matchMedia(`(prefers-color-scheme: light)`).addEventListener('change', () => {
    if (loadTheme() === 'auto') onThemeChange('auto');
  });

  class StarlightThemeSelect extends HTMLElement {
    constructor() {
      super();
      const currentTheme = loadTheme();
      onThemeChange(currentTheme);

      // Toggle between light and dark on click
      this.querySelector('button')?.addEventListener('click', () => {
        const current = document.documentElement.dataset.theme;
        const next: Theme = current === 'dark' ? 'light' : 'dark';
        onThemeChange(next);
      });
    }
  }
  customElements.define('starlight-theme-select', StarlightThemeSelect);
</script>

<style>
  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    border: none;
    border-radius: 0.375rem;
    background: transparent;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }

  .theme-toggle:hover {
    background: var(--theme-bg-hover, var(--sl-color-gray-6));
  }

  .icon {
    width: 1rem;
    height: 1rem;
  }

  /* Light mode: show sun, hide moon */
  .icon-sun {
    display: block;
    color: var(--sl-color-gray-3);
  }
  .icon-moon {
    display: none;
    color: var(--sl-color-gray-3);
  }

  .theme-toggle:hover .icon-sun {
    color: var(--sl-color-gray-1);
  }

  /* Dark mode: show moon, hide sun */
  :global([data-theme='dark']) .icon-sun {
    display: none;
  }
  :global([data-theme='dark']) .icon-moon {
    display: block;
  }
  :global([data-theme='dark']) .theme-toggle:hover .icon-moon {
    color: var(--sl-color-gray-2);
  }
</style>
