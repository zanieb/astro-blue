---
/**
 * Custom theme toggle - Mintlify style icon button
 * Replaces default Starlight dropdown with a simple toggle button
 */

import SunIcon from '../icons/SunIcon.astro';
import MoonIcon from '../icons/MoonIcon.astro';
---

<starlight-theme-select>
  <button class="theme-toggle group" aria-label={Astro.locals.t('themeSelect.accessibleLabel')}>
    <!-- Sun icon - visible in light mode -->
    <span class="icon icon-sun">
      <SunIcon />
    </span>
    <!-- Moon icon - visible in dark mode -->
    <span class="icon icon-moon">
      <MoonIcon />
    </span>
  </button>
</starlight-theme-select>

{/* Inlined to avoid FOUC. Uses global scope from ThemeProvider.astro */}
<script is:inline>
  /* global StarlightThemeProvider */
  StarlightThemeProvider.updatePickers();
</script>

<script>
  type Theme = 'auto' | 'dark' | 'light';

  const storageKey = 'starlight-theme';

  const parseTheme = (theme: unknown): Theme =>
    theme === 'auto' || theme === 'dark' || theme === 'light' ? theme : 'auto';

  const loadTheme = (): Theme =>
    parseTheme(typeof localStorage !== 'undefined' && localStorage.getItem(storageKey));

  function storeTheme(theme: Theme): void {
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem(storageKey, theme === 'light' || theme === 'dark' ? theme : '');
    }
  }

  const getPreferredColorScheme = (): Theme =>
    matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';

  function onThemeChange(theme: Theme): void {
    // eslint-disable-next-line no-undef
    StarlightThemeProvider.updatePickers(theme);
    document.documentElement.dataset.theme = theme === 'auto' ? getPreferredColorScheme() : theme;
    storeTheme(theme);
  }

  matchMedia(`(prefers-color-scheme: light)`).addEventListener('change', () => {
    if (loadTheme() === 'auto') onThemeChange('auto');
  });

  class StarlightThemeSelect extends HTMLElement {
    constructor() {
      super();
      const currentTheme = loadTheme();
      onThemeChange(currentTheme);

      // Toggle between light and dark on click
      this.querySelector('button')?.addEventListener('click', () => {
        const current = document.documentElement.dataset.theme;
        const next: Theme = current === 'dark' ? 'light' : 'dark';
        onThemeChange(next);
      });
    }
  }
  customElements.define('starlight-theme-select', StarlightThemeSelect);
</script>

<style>
  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    border: none;
    border-radius: 0.375rem;
    background: transparent;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }

  .theme-toggle:hover {
    background: var(--theme-bg-hover, var(--sl-color-gray-6));
  }

  .icon {
    display: inline-flex;
    width: 1rem;
    height: 1rem;
  }

  .icon svg {
    width: 100%;
    height: 100%;
  }

  /* Light mode: show sun, hide moon */
  .icon-sun {
    display: inline-flex;
    color: var(--sl-color-gray-3);
  }
  .icon-moon {
    display: none;
    color: var(--sl-color-gray-3);
  }

  .theme-toggle:hover .icon-sun {
    color: var(--sl-color-gray-1);
  }

  /* Dark mode: show moon, hide sun */
  :global([data-theme='dark']) .icon-sun {
    display: none;
  }
  :global([data-theme='dark']) .icon-moon {
    display: inline-flex;
  }
  :global([data-theme='dark']) .theme-toggle:hover .icon-moon {
    color: var(--sl-color-gray-2);
  }
</style>
