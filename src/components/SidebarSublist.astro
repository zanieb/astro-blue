---
/**
 * Custom SidebarSublist component that makes group headings clickable links.
 *
 * If a group has an index page (first entry with data-index="true" attribute),
 * the group label becomes a clickable link to that page. The expand/collapse
 * chevron still works independently.
 *
 * Groups without index pages are NOT clickable - they just expand/collapse.
 */
import { Icon, Badge } from '@astrojs/starlight/components';

// Define sidebar types locally since they're not exported
interface SidebarLink {
	type: 'link';
	label: string;
	href: string;
	isCurrent: boolean;
	badge: { variant?: string; class?: string; text: string } | undefined;
	attrs: Record<string, unknown>;
}

interface SidebarGroup {
	type: 'group';
	label: string;
	entries: SidebarEntry[];
	collapsed: boolean;
	badge: { variant?: string; class?: string; text: string } | undefined;
}

type SidebarEntry = SidebarLink | SidebarGroup;

interface Props {
	sublist: SidebarEntry[];
	nested?: boolean;
}

const { sublist, nested } = Astro.props;

// SidebarRestorePoint logic inlined
const currentGroupIndexSymbol = Symbol.for('starlight-sidebar-group-index');
const locals = Astro.locals as App.Locals & { [currentGroupIndexSymbol]: number };

function getRestoreIndex(): number {
	const index = locals[currentGroupIndexSymbol] || 0;
	locals[currentGroupIndexSymbol] = index + 1;
	return index;
}

/**
 * Flatten a sidebar tree into a list of links.
 */
function flattenSidebar(sidebar: SidebarEntry[]): SidebarLink[] {
	return sidebar.flatMap((entry) =>
		entry.type === 'group' ? flattenSidebar(entry.entries) : entry
	);
}

/**
 * Check if an entry is marked as an index page.
 */
function isIndexEntry(entry: SidebarEntry): boolean {
	return entry.type === 'link' && entry.attrs['data-index'] === 'true';
}

/**
 * Get the index page link for a group if it exists.
 * Returns the href of the first entry if it has data-index="true".
 */
function getIndexPageLink(entry: SidebarGroup): string | undefined {
	const firstEntry = entry.entries[0];
	if (firstEntry && isIndexEntry(firstEntry)) {
		return firstEntry.href;
	}
	return undefined;
}

/**
 * Check if the index page is the current page.
 */
function isIndexPageCurrent(entry: SidebarGroup): boolean {
	const firstEntry = entry.entries[0];
	if (firstEntry && isIndexEntry(firstEntry)) {
		return (firstEntry as SidebarLink).isCurrent;
	}
	return false;
}

/**
 * Check if any entry in the group is the current page.
 */
function hasCurrentPage(entry: SidebarGroup): boolean {
	return flattenSidebar(entry.entries).some((i) => i.isCurrent);
}

/**
 * Get entries to display, excluding the index page (since heading links to it).
 */
function getDisplayEntries(entry: SidebarGroup): SidebarEntry[] {
	const firstEntry = entry.entries[0];
	if (firstEntry && isIndexEntry(firstEntry)) {
		return entry.entries.slice(1);
	}
	return entry.entries;
}
---

<ul class:list={{ 'top-level': !nested }}>
	{
		sublist.map((entry) => (
			<li>
				{entry.type === 'link' ? (
					<a
						href={entry.href}
						aria-current={entry.isCurrent && 'page'}
						class:list={[{ large: !nested }, entry.attrs.class]}
						{...entry.attrs}
					>
						<span>{entry.label}</span>
						{entry.badge && (
							<Badge
								variant={entry.badge.variant}
								class={entry.badge.class}
								text={entry.badge.text}
							/>
						)}
					</a>
				) : (
					<details
						open={hasCurrentPage(entry) || !entry.collapsed}
					>
						<summary>
							{getIndexPageLink(entry) ? (
								<a
									href={getIndexPageLink(entry)}
									class="group-link"
									aria-current={isIndexPageCurrent(entry) && 'page'}
								>
									<span class="group-label">
										<span class="large">{entry.label}</span>
										{entry.badge && (
											<Badge
												variant={entry.badge.variant}
												class={entry.badge.class}
												text={entry.badge.text}
											/>
										)}
									</span>
								</a>
							) : (
								<span class="group-label">
									<span class="large">{entry.label}</span>
									{entry.badge && (
										<Badge
											variant={entry.badge.variant}
											class={entry.badge.class}
											text={entry.badge.text}
										/>
									)}
								</span>
							)}
							<Icon name="right-caret" class="caret" size="1.25rem" />
						</summary>
						<sl-sidebar-restore data-index={getRestoreIndex()}></sl-sidebar-restore>
						<Astro.self sublist={getDisplayEntries(entry)} nested />
					</details>
				)}
			</li>
		))
	}
</ul>

<style>
	@layer starlight.core {
		ul {
			--sl-sidebar-item-padding-inline: 0.5rem;
			list-style: none;
			padding: 0;
		}

		li {
			overflow-wrap: anywhere;
		}

		ul ul li {
			margin-inline-start: var(--sl-sidebar-item-padding-inline);
			border-inline-start: 1px solid var(--sl-color-hairline-light);
			padding-inline-start: var(--sl-sidebar-item-padding-inline);
		}

		.large {
			font-size: var(--sl-text-lg);
			font-weight: 600;
			color: var(--sl-color-white);
		}

		.top-level > li + li {
			margin-top: 0.75rem;
		}

		summary {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0.2em var(--sl-sidebar-item-padding-inline);
			line-height: 1.4;
			cursor: pointer;
			user-select: none;
		}
		summary::marker,
		summary::-webkit-details-marker {
			display: none;
		}

		.group-link {
			text-decoration: none;
			color: inherit;
			flex: 1;
		}

		.group-link:hover .large,
		.group-link:focus .large {
			color: var(--sl-color-text-accent);
		}

		/* Highlight group label when index page is current */
		.group-link[aria-current='page'] .large {
			color: var(--sl-color-text-accent);
		}

		.group-label {
			flex: 1;
		}

		.caret {
			transition: transform 0.2s ease-in-out;
			flex-shrink: 0;
		}
		:global([dir='rtl']) .caret {
			transform: rotateZ(180deg);
		}
		[open] > summary .caret {
			transform: rotateZ(90deg);
		}

		a {
			display: block;
			border-radius: 0.25rem;
			text-decoration: none;
			color: var(--sl-color-gray-2);
			padding: 0.3em var(--sl-sidebar-item-padding-inline);
			line-height: 1.4;
		}

		a:hover,
		a:focus {
			color: var(--sl-color-white);
		}

		[aria-current='page'],
		[aria-current='page']:hover,
		[aria-current='page']:focus {
			font-weight: 600;
			color: var(--sl-color-text-invert);
			background-color: var(--sl-color-text-accent);
		}

		/* Override for group links - don't use full background highlight */
		summary a[aria-current='page'],
		summary a[aria-current='page']:hover,
		summary a[aria-current='page']:focus {
			background-color: transparent;
			color: inherit;
		}

		a > *:not(:last-child),
		.group-label > *:not(:last-child) {
			margin-inline-end: 0.25em;
		}

		@media (min-width: 50rem) {
			.top-level > li + li {
				margin-top: 0.5rem;
			}
			.large {
				font-size: var(--sl-text-base);
			}
			a {
				font-size: var(--sl-text-sm);
			}
		}
	}
</style>
